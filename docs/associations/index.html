<!DOCTYPE html>
<html lang='en-US' xml:lang='en-US' xmlns='http://www.w3.org/1999/xhtml'>
  <head>
    <meta content='text/html; charset=utf-8' http-equiv='Content-Type'>
    <title>Mongoid Documentation: Associations</title>
    <link href='/stylesheets/docs.css' media='all' rel='stylesheet' type='text/css'>
  </head>
  <body>
    <div id='docs'>
      <div id='page_menu'>
        <ul>
          <li class=''>
            <a href='/'>Home</a>
          </li>
          <li class='current_page_item'>
            <a href='/docs/installation/'>Documentation</a>
          </li>
          <li class=''>
            <a href='/links/'>Links</a>
          </li>
          <li class=''>
            <a href='/about/'>About</a>
          </li>
        </ul>
      </div>
      <div id='header'>
        <a href='/'>
          <h1 class='logo' title='[mon-goyd]'>MONGOID</h1>
        </a>
        <a class='docs_header' href='../installation/'>Documentation</a>
      </div>
      <div class='main'>
        <div class='border'>
          <div class='content_body colorize'>
            <h2>Associations</h2>
            <div class="text">&#x000A;  A <tt>Mongoid::Document</tt> can have associations to other documents through 3 traditional&#x000A;  ActiveRecord-style macros: <tt>embeds_one</tt>, <tt>embeds_many</tt> and <tt>embedded_in</tt>.&#x000A;  When setting up associations, one document will act as the root for all other objects in the&#x000A;  graph, and all associations will be <i>embedded</i> within that root document in the graph&#x000A;  as well as the database itself. Relational associations to documents in other collections are not handled by these macros. Please see the Relational associations below.&#x000A;  <br><br>&#x000A;  Considering the person model from previous examples, associations to other documents would&#x000A;  be set up like so:&#x000A;  <br><br><tt>person.rb</tt>:&#x000A;  <pre><code class="language-ruby"><span class="r">class</span> <span class="cl">Person</span>&#x000A;  include <span class="co">Mongoid</span>::<span class="co">Document</span>&#x000A;  field <span class="sy">:first_name</span>&#x000A;  field <span class="sy">:last_name</span>&#x000A;  embeds_one <span class="sy">:address</span>&#x000A;  embeds_many <span class="sy">:phones</span>&#x000A;<span class="r">end</span></code></pre>&#x000A;  <tt>address.rb</tt>:&#x000A;  <pre><code class="language-ruby"><span class="r">class</span> <span class="cl">Address</span>&#x000A;  include <span class="co">Mongoid</span>::<span class="co">Document</span>&#x000A;  field <span class="sy">:street</span>&#x000A;  field <span class="sy">:city</span>&#x000A;  field <span class="sy">:state</span>&#x000A;  field <span class="sy">:post_code</span>&#x000A;  embedded_in <span class="sy">:person</span>, <span class="sy">:inverse_of</span> =&gt; <span class="sy">:address</span>&#x000A;<span class="r">end</span></code></pre>&#x000A;  <tt>phone.rb</tt>:&#x000A;  <pre><code class="language-ruby"><span class="r">class</span> <span class="cl">Phone</span>&#x000A;  include <span class="co">Mongoid</span>::<span class="co">Document</span>&#x000A;  field <span class="sy">:country_code</span>, <span class="sy">:type</span> =&gt; <span class="co">Integer</span>, <span class="sy">:default</span> =&gt; <span class="i">1</span>&#x000A;  field <span class="sy">:number</span>&#x000A;  embedded_in <span class="sy">:person</span>, <span class="sy">:inverse_of</span> =&gt; <span class="sy">:phones</span>&#x000A;<span class="r">end</span></code></pre>&#x000A;  Given the above models, an example person saved to the database would have this structure in BSON,&#x000A;  where a <tt>embeds_one</tt> gets embedded as a hash and a <tt>embeds_many</tt> gets embedded as an&#x000A;  array of hashes.&#x000A;  Note that the <tt>embedded_in</tt> macro MUST be defined in order for the embedding to work -&#x000A;  don't forget it!&#x000A;  <pre><code class="language-ruby">{&#x000A;  first_name: <span class="s"><span class="dl">"</span><span class="k">Durran</span><span class="dl">"</span></span>,&#x000A;  last_name: <span class="s"><span class="dl">"</span><span class="k">Jordan</span><span class="dl">"</span></span>,&#x000A;  address: {&#x000A;    street: <span class="s"><span class="dl">"</span><span class="k">30 Rockefeller Plaza</span><span class="dl">"</span></span>,&#x000A;    city: <span class="s"><span class="dl">"</span><span class="k">New York</span><span class="dl">"</span></span>,&#x000A;    state: <span class="s"><span class="dl">"</span><span class="k">NY</span><span class="dl">"</span></span>,&#x000A;    post_code: <span class="s"><span class="dl">"</span><span class="k">10112</span><span class="dl">"</span></span>&#x000A;  },&#x000A;  phones: [ { country_code: <span class="i">1</span>, number: <span class="s"><span class="dl">"</span><span class="k">212-555-1212</span><span class="dl">"</span></span> } ]&#x000A;}</code></pre>&#x000A;  Associations may have options associated with them, the most important of which is the <i>required</i>&#x000A;  option of <tt>inverse_of</tt> on a <tt>embedded_in</tt> association. In order to properly set up the&#x000A;  relationships and make sure the object graph is always up to date with any modifications to any object,&#x000A;  the <tt>embedded_in</tt> association must provide this option (and be present itself). The value should&#x000A;  be set to the name of the association in its parent object. In addition, a <tt>class_name</tt> option&#x000A;  may be provided if the name of the association differs from a singular or plural form of the document's&#x000A;  class name. We can modify the examples above to show what an updated person would look like with the&#x000A;  phones association name changed:&#x000A;  <br><br><tt>person.rb</tt>:&#x000A;  <pre><code class="language-ruby"><span class="r">class</span> <span class="cl">Person</span>&#x000A;  include <span class="co">Mongoid</span>::<span class="co">Document</span>&#x000A;  field <span class="sy">:first_name</span>&#x000A;  field <span class="sy">:last_name</span>&#x000A;  embeds_one <span class="sy">:address</span>&#x000A;  embeds_many <span class="sy">:phone_numbers</span>, <span class="sy">:class_name</span> =&gt; <span class="s"><span class="dl">"</span><span class="k">Phone</span><span class="dl">"</span></span>&#x000A;<span class="r">end</span></code></pre>&#x000A;  <br>&#x000A;</div>&#x000A;<div class="title">Building and Creating Associations</div>&#x000A;<div class="text">&#x000A;  Associations can be set directly, appended to, built, or created in certain cases:&#x000A;  <br><br><tt>embeds_one</tt>:&#x000A;  <pre><code class="language-ruby">person = <span class="co">Person</span>.new&#x000A;&#x000A;person.build_address(<span class="sy">:street</span> =&gt; <span class="s"><span class="dl">"</span><span class="k">Oxford Street</span><span class="dl">"</span></span>)&#x000A;person.create_address(<span class="sy">:street</span> =&gt; <span class="s"><span class="dl">"</span><span class="k">Oxford Street</span><span class="dl">"</span></span>)&#x000A;person.address = <span class="co">Address</span>.new(<span class="sy">:street</span> =&gt; <span class="s"><span class="dl">"</span><span class="k">Oxford Street</span><span class="dl">"</span></span>)</code></pre>&#x000A;  <tt>embeds_many</tt>:&#x000A;  <pre><code class="language-ruby">person = <span class="co">Person</span>.new&#x000A;&#x000A;person.phone_numbers.build(<span class="sy">:number</span> =&gt; <span class="s"><span class="dl">"</span><span class="k">415-555-1212</span><span class="dl">"</span></span>)&#x000A;person.phone_numbers.create(<span class="sy">:number</span> =&gt; <span class="s"><span class="dl">"</span><span class="k">415-555-1212</span><span class="dl">"</span></span>)&#x000A;person.phone_numbers &lt;&lt; <span class="co">Phone</span>.new(<span class="sy">:number</span> =&gt; <span class="s"><span class="dl">"</span><span class="k">415-555-1212</span><span class="dl">"</span></span>)&#x000A;person.phone_numbers = [ <span class="co">Phone</span>.new(<span class="sy">:number</span> =&gt; <span class="s"><span class="dl">"</span><span class="k">415-555-1212</span><span class="dl">"</span></span>) ]</code></pre>&#x000A;  <tt>embedded_in</tt>:&#x000A;  <pre><code class="language-ruby">address = <span class="co">Address</span>.new&#x000A;address.person = <span class="co">Person</span>.new(<span class="sy">:first_name</span> =&gt; <span class="s"><span class="dl">"</span><span class="k">Mark</span><span class="dl">"</span></span>)</code></pre>&#x000A;  <br>&#x000A;</div>&#x000A;<div class="title">Polymorphic Associations</div>&#x000A;<div class="text">&#x000A;  By default, all <tt>embedded_in</tt> associations are polymorphic. No matter what name you provide&#x000A;  to the macro it will always return the parent object. You may provide the <tt>:polymorphic =&gt; true</tt>&#x000A;  option if you like as a "security blanket", but it will actually do nothing extra. An example of&#x000A;  this given the above models would be:&#x000A;  <br><br><tt>address.rb</tt>:&#x000A;  <pre><code class="language-ruby"><span class="r">class</span> <span class="cl">Address</span>&#x000A;  include <span class="co">Mongoid</span>::<span class="co">Document</span>&#x000A;  field <span class="sy">:street</span>&#x000A;  field <span class="sy">:city</span>&#x000A;  field <span class="sy">:state</span>&#x000A;  field <span class="sy">:post_code</span>&#x000A;  embedded_in <span class="sy">:addressable</span>, <span class="sy">:inverse_of</span> =&gt; <span class="sy">:address</span>&#x000A;<span class="r">end</span></code></pre>&#x000A;  In the above example, address.addressable would actually return the parent object, which is the Person.&#x000A;  <br><br>&#x000A;</div>&#x000A;<div class="title">Association Extensions</div>&#x000A;<div class="text">&#x000A;  Mongoid supports anonymous association extensions. Access the proxied target&#x000A;  with the <tt>@target</tt> instance variable. Access the parent document with&#x000A;  the <tt>@parent</tt> instance variable.&#x000A;  <br><br><tt>person.rb</tt>:&#x000A;  <pre><code class="language-ruby"><span class="r">class</span> <span class="cl">Person</span>&#x000A;  include <span class="co">Mongoid</span>::<span class="co">Document</span>&#x000A;  field <span class="sy">:name</span>&#x000A;  embeds_many <span class="sy">:addresses</span> <span class="r">do</span>&#x000A;    <span class="r">def</span> <span class="fu">california</span>&#x000A;      <span class="iv">@target</span>.select { |address| address.state == <span class="s"><span class="dl">"</span><span class="k">CA</span><span class="dl">"</span></span> }&#x000A;    <span class="r">end</span>&#x000A;    &#x000A;    <span class="r">def</span> <span class="fu">domestic</span>&#x000A;      <span class="iv">@target</span>.select { |address| address.country == <span class="iv">@parent</span>.country_of_origin }&#x000A;    <span class="r">end</span>&#x000A;  <span class="r">end</span>&#x000A;<span class="r">end</span></code></pre>&#x000A;  In the above example, <tt>person.addresses.california</tt> would return only CA addresses,&#x000A;  and <tt>person.addresses.domestic</tt> would return only addresses with the same&#x000A;  <tt>country</tt> as <tt>person.country_of_origin</tt>.&#x000A;  <br><br>&#x000A;</div>&#x000A;<div class="title">Relational Associations</div>&#x000A;<div class="text">&#x000A;  Mongoid supports basic relational associations to documents in another collection, or objects&#x000A;  that reside in another database. The related object must support ActiveRecord style finders&#x000A;  in order for the association to work. The 3 macros provided are <tt>references_one</tt>,&#x000A;  <tt>references_many</tt>, and <tt>referenced_in</tt>. When using the macros an id&#x000A;  field will be created on the object that is on the <tt>referenced_in</tt> side of the association,&#x000A;  unless using the <tt>:stored_as</tt> option, which will store ids for the other objects&#x000A;  as an array on the defined document and vise-versa. Note that the <tt>inverse_of</tt> option&#x000A;  is a requirement in this case.&#x000A;  <br><br><tt>person.rb</tt>&#x000A;  <pre><code class="language-ruby"><span class="r">class</span> <span class="cl">Person</span>&#x000A;  include <span class="co">Mongoid</span>::<span class="co">Document</span>&#x000A;  references_one <span class="sy">:policy</span>&#x000A;  references_many <span class="sy">:prescriptions</span>&#x000A;  references_many <span class="sy">:preferences</span>, <span class="sy">:stored_as</span> =&gt; <span class="sy">:array</span>, <span class="sy">:inverse_of</span> =&gt; <span class="sy">:people</span>&#x000A;<span class="r">end</span>&#x000A;&#x000A;<span class="r">class</span> <span class="cl">Policy</span>&#x000A;  include <span class="co">Mongoid</span>::<span class="co">Document</span>&#x000A;  referenced_in <span class="sy">:person</span>&#x000A;<span class="r">end</span>&#x000A;&#x000A;<span class="r">class</span> <span class="cl">Prescription</span>&#x000A;  include <span class="co">Mongoid</span>::<span class="co">Document</span>&#x000A;  referenced_in <span class="sy">:person</span>&#x000A;<span class="r">end</span>&#x000A;&#x000A;<span class="r">class</span> <span class="cl">Preference</span>&#x000A;  include <span class="co">Mongoid</span>::<span class="co">Document</span>&#x000A;  references_many <span class="sy">:people</span>, <span class="sy">:stored_as</span> =&gt; <span class="sy">:array</span>, <span class="sy">:inverse_of</span> =&gt; <span class="sy">:preferences</span>&#x000A;<span class="r">end</span>&#x000A;&#x000A;person = <span class="co">Person</span>.create&#x000A;policy = <span class="co">Policy</span>.create&#x000A;prescription = <span class="co">Prescription</span>.create&#x000A;&#x000A;person.policy = policy&#x000A;person.prescriptions = [prescription]</code></pre>&#x000A;</div>&#x000A;<div class="title">Cascading Removals</div>&#x000A;<div class="text">&#x000A;  <p>&#x000A;    Similar to ActiveRecord, if you want child relational associations to be&#x000A;    deleted when the parent record is deleted, simply supply the <tt>:dependent</tt>&#x000A;    option on the <tt>references_one</tt> or <tt>references_many</tt> macro.&#x000A;  </p>&#x000A;  <pre><code class="language-ruby"><span class="r">class</span> <span class="cl">Person</span>&#x000A;  include <span class="co">Mongoid</span>::<span class="co">Document</span>&#x000A;  references_one <span class="sy">:policy</span>, <span class="sy">:dependent</span> =&gt; <span class="sy">:destroy</span>&#x000A;  references_many <span class="sy">:prescriptions</span>, <span class="sy">:dependent</span> =&gt; <span class="sy">:delete</span>&#x000A;<span class="r">end</span></code></pre>&#x000A;</div>&#x000A;&#x000A;
          </div>
        </div>
      </div>
      <div id='rightcolumn'>
        <div class='box' id='search'>
          <div class='roundedbox'>
            <h3>Contents</h3>
          </div>
        </div>
        <ul class='outline'>
          <li><a href="/docs/installation/">Installation</a></li>
          <li><a href="/docs/documents/">Documents</a></li>
          <li><span class="active" title="You're here.">Associations</span></li>
          <li><a href="/docs/persistence/">Persistence</a></li>
          <li><a href="/docs/querying/">Querying</a></li>
          <li><a href="/docs/callbacks/">Callbacks</a></li>
          <li><a href="/docs/validation/">Validation</a></li>
          <li><a href="/docs/inheritance/">Inheritance</a></li>
          <li><a href="/docs/indexing/">Indexing</a></li>
          <li><a href="/docs/extras/">Extras</a></li>
          <li><a href="/docs/rake/">Rake Tasks</a></li>
          <li><a href="/docs/integration/">Integration</a></li>
          <li><a href="/docs/extensions/">Extensions</a></li>
          <li><a href="/docs/upgrading/">Upgrading</a></li>
        </ul>
      </div>
      <div id='footer'>
        <p>
          Mongoid is maintained by <a href="http://twitter.com/modetojoy">Durran Jordan</a>, Site by <a href="http://twitter.com/railsjedi">@railsjedi</a> and <a href="http://twitter.com/fredrikhenne">@fredrikhenne</a>. Mongoid is free software under the MIT license.
        </p>
      </div>
    </div>
    <div id='ribbon'>
      <p>
        <a href='http://github.com/mongoid/mongoid-site' rel='me' title='Fork me on GitHub!'>Fork me on GitHub!</a>
      </p>
    </div>
  </body>
</html>
